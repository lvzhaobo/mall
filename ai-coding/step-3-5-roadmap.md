# mall电商系统 - 价格体系Bug修复 Roadmap

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 价格体系Bug修复项目路线图 |
| **文档版本** | v1.0 |
| **创建时间** | 2026-01-02 |
| **项目周期** | 25个工作日 (5周) |
| **关联文档** | [PRD修正版](./step-4-2-prd-corrected.md) |

---

## 一、项目总览

### 1.1 时间线概览

```
Week 1         Week 2         Week 3         Week 4         Week 5
├──────────────┼──────────────┼──────────────┼──────────────┼──────────────┤
│  阶段1: P0   │  阶段1: P0   │  阶段2: P1   │  阶段2: P1   │  阶段3: P2   │
│  需求评审    │  开发+测试   │  方案设计    │  性能优化    │  上线准备    │
│  技术设计    │  代码审查    │  安全加固    │  安全测试    │  灰度发布    │
└──────────────┴──────────────┴──────────────┴──────────────┴──────────────┘
  M1 M2          M3             M4                            M5 M6 M7
```

### 1.2 项目目标

| 维度 | 当前状态 | 目标状态 | 度量指标 |
|------|---------|---------|---------|
| **系统稳定性** | 🔴 存在空指针/除零异常 | 🟢 无严重异常 | 生产环境0异常告警 |
| **数据准确性** | 🔴 精度问题导致误差 | 🟢 100%准确 | 财务对账数据一致 |
| **响应性能** | 🟡 大批量商品响应慢(~1s) | 🟢 < 500ms | 95th百分位响应时间 |
| **安全性** | 🟡 存在价格篡改风险 | 🟢 无高危漏洞 | 通过安全审计 |

---

## 二、详细Roadmap

### 📅 第1周: 阶段1启动 - P0级严重Bug修复

#### Day 1 (2026-01-06 周一)

**里程碑**: M1 - 需求评审通过

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | 需求评审会议 | 产品+技术团队 | 评审纪要 | ⏳ 待开始 |
| 10:00-12:00 | 技术方案设计 (启动) | Tech Lead | 技术方案草稿 | ⏳ 待开始 |
| 14:00-18:00 | 技术方案设计 (完成) | Tech Lead | 技术设计文档 | ⏳ 待开始 |

**关键决策点**:
- ✅ 确认15个Bug的修复优先级
- ✅ 确认价格快照是否实施 (建议暂不实施)
- ✅ 确认技术栈约束 (JDK 1.8, Spring Boot 2.7.5)

---

#### Day 2 (2026-01-07 周二)

**里程碑**: M2 - 技术方案评审通过

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-11:00 | 设计评审会议 | 技术团队 | 评审纪要 | ⏳ 待开始 |
| 11:00-12:00 | 搭建测试环境 | 测试B + 运维F | 测试环境 | ⏳ 待开始 |
| 14:00-18:00 | 空指针异常修复 (启动) | 开发A | 代码框架 | ⏳ 待开始 |

**技术方案评审重点**:
- 空指针异常的统一处理方案
- BigDecimal精度处理策略
- 性能优化的Map方案
- Redis缓存设计

---

#### Day 3 (2026-01-08 周三)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 全天 | 空指针异常修复 (完成) | 开发A | 代码+单元测试 | ⏳ 待开始 |
| 下午 | 除零异常修复 (启动) | 开发A | 代码框架 | ⏳ 待开始 |

**开发内容**:
- 修复`OmsPromotionServiceImpl.java`第48-52行空指针
- 处理SKU为null的场景
- 处理促销价为null的场景
- 编写单元测试 (3种促销类型)

---

#### Day 4 (2026-01-09 周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | 除零异常修复 (完成) | 开发A | 代码+单元测试 | ⏳ 待开始 |
| 下午 | 精度问题修复 (启动) | 开发A | 代码框架 | ⏳ 待开始 |

**开发内容**:
- 修复满减除零异常 (第94行)
- 检查`totalAmount`是否为0
- 测试边界场景 (0.01元)

---

#### Day 5 (2026-01-10 周五)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 全天 | 精度问题修复 (完成) | 开发A | 代码+单元测试 | ⏳ 待开始 |

**开发内容**:
- 实现"最后补齐差额"算法
- 确保分摊精度100%准确
- 单元测试验证: `sum(reduceAmount) == fullReduction.getReducePrice()`

---

### 📅 第2周: 阶段1完成 - P0级测试与审查

#### Day 6 (2026-01-13 周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | realStock修复 | 开发A | 代码+单元测试 | ⏳ 待开始 |
| 下午 | 代码审查 (第1轮) | Tech Lead | 审查意见 | ⏳ 待开始 |

**代码审查重点**:
- 空指针处理的完整性
- BigDecimal使用的正确性
- 单元测试覆盖率
- 日志记录的完整性

---

#### Day 7 (2026-01-14 周二)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | 修改代码 (审查意见) | 开发A | 修改后代码 | ⏳ 待开始 |
| 下午 | 代码审查 (第2轮) | Tech Lead | 审查通过 | ⏳ 待开始 |

---

#### Day 8-9 (2026-01-15 ~ 01-16 周三-周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 2天 | 集成测试 | 测试B | 测试报告 | ⏳ 待开始 |

**测试内容**:
- P0级4个Bug的完整测试
- 回归测试 (验证其他功能无影响)
- 性能基准测试

---

#### Day 10 (2026-01-17 周五)

**里程碑**: M3 - P0级Bug修复完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | Bug修复 (测试反馈) | 开发A | Bug修复 | ⏳ 待开始 |
| 下午 | 里程碑评审 | 全员 | 评审纪要 | ⏳ 待开始 |

**验收标准**:
- ✅ 4个P0级Bug全部修复
- ✅ 单元测试覆盖率 > 60%
- ✅ 集成测试通过率 = 100%
- ✅ 无新增Bug

---

### 📅 第3周: 阶段2启动 - P1级高危问题修复

#### Day 11 (2026-01-20 周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | 满减规则精度修复 | 开发A | 代码 | ⏳ 待开始 |
| 下午 | 阶梯排序修复 | 开发A | 代码 | ⏳ 待开始 |

**开发内容**:
- 使用`BigDecimal.compareTo()`替代`intValue()`
- 使用`Comparator.comparingInt().reversed()`替代减法

---

#### Day 12 (2026-01-21 周二)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 全天 | 价格验证方案设计 | Tech Lead | 设计方案 | ⏳ 待开始 |

**设计重点**:
- 服务端价格验证策略
- Redis缓存设计 (5分钟)
- 唯一索引设计: `UNIQUE(member_id, product_id, sku_id)`
- 并发处理策略

---

#### Day 13-14 (2026-01-22 ~ 01-23 周三-周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 2天 | 价格验证开发 | 开发A | 代码+单元测试 | ⏳ 待开始 |

**开发内容**:
- 添加购物车前查询真实商品信息
- 强制使用服务端价格
- 验证SKU是否存在
- 验证库存是否充足

---

#### Day 15 (2026-01-24 周五)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | Redis缓存开发 (并行) | 开发C | 缓存逻辑 | ⏳ 待开始 |
| 下午 | Map优化开发 | 开发A | 代码 | ⏳ 待开始 |

**开发内容**:
- 实现商品信息Redis缓存
- 将`List<PromotionProduct>`转换为`Map<Long, PromotionProduct>`
- 性能优化: O(N×M) → O(N+M)

---

### 📅 第4周: 阶段2完成 - 性能与安全测试

#### Day 16 (2026-01-27 周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | 数据库索引评审 | DBA | 评审意见 | ⏳ 待开始 |
| 下午 | 添加索引 (业务低峰期) | DBA | 索引脚本 | ⏳ 待开始 |

**索引变更**:
```sql
ALTER TABLE pms_sku_stock ADD INDEX idx_product_id (product_id);
ALTER TABLE pms_product_ladder ADD INDEX idx_product_id (product_id);
ALTER TABLE pms_product_full_reduction ADD INDEX idx_product_id (product_id);
```

**风险控制**:
- 使用`pt-online-schema-change`工具
- 在业务低峰期执行 (下午14:00-16:00)
- 准备回滚脚本

---

#### Day 17 (2026-01-28 周二)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 全天 | 代码审查 (P1级) | Tech Lead | 审查通过 | ⏳ 待开始 |

**审查重点**:
- 价格验证逻辑的完整性
- Redis缓存的一致性
- Map优化的正确性
- 并发问题处理

---

#### Day 18-19 (2026-01-29 ~ 01-30 周三-周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 2天 | 性能测试 | 测试B | 性能报告 | ⏳ 待开始 |

**性能测试目标**:

| 指标 | 当前 | 目标 | 测试方法 |
|------|-----|-----|---------|
| 购物车查询(10商品) | ~100ms | < 200ms (95th) | JMeter 1000并发 |
| 购物车查询(50商品) | ~800ms | < 500ms (95th) | JMeter 1000并发 |
| 购物车查询(100商品) | ~2000ms | < 500ms (95th) | JMeter 1000并发 |
| 购物车添加 | ~150ms | < 200ms (95th) | JMeter 500并发 |
| QPS | ~500 | > 1000 | JMeter压力测试 |

---

#### Day 20-21 (2026-01-31 ~ 02-01 周五-周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 2天 | 安全测试 | 安全D | 安全报告 | ⏳ 待开始 |

**安全测试内容**:
- 价格篡改测试 (客户端传入0.01元)
- SQL注入测试 (SQLMap扫描)
- XSS攻击测试
- 越权访问测试
- SonarQube代码扫描

---

#### Day 22 (2026-02-02 周二)

**里程碑**: M4 - P1级问题修复完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | Bug修复 (性能/安全反馈) | 开发A | Bug修复 | ⏳ 待开始 |
| 下午 | 里程碑评审 | 全员 | 评审纪要 | ⏳ 待开始 |

**验收标准**:
- ✅ 6个P1级问题全部修复
- ✅ 性能测试指标达标
- ✅ 安全测试无高危漏洞
- ✅ 无新增Bug

---

### 📅 第5周: 阶段3 - P2级优化与上线准备

#### Day 23 (2026-02-03 周三)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 上午 | 库存计算修复 + IN查询限制 | 开发A | 代码 | ⏳ 待开始 |
| 下午 | 排序优化 + 对象创建优化 | 开发A | 代码 | ⏳ 待开始 |

**P2级优化内容**:
- 使用`Math.max(0, stock - lockStock)`确保不为负
- 限制单次查询最多100个商品
- SQL中添加`ORDER BY`子句
- 使用`new ArrayList<>(itemList.size())`预分配容量

---

#### Day 24-25 (2026-02-04 ~ 02-05 周四-周五)

**里程碑**: M5 - P2级优化完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 2天 | 回归测试 | 测试B | 测试报告 | ⏳ 待开始 |
| Day 25上午 | 文档更新 | 开发A | 技术文档 | ⏳ 待开始 |
| Day 25下午 | 灰度发布方案 | 运维F | 灰度方案 | ⏳ 待开始 |
| Day 25下午 | 监控配置 | 运维F | 监控大盘 | ⏳ 待开始 |
| Day 25下午 | 团队培训 | Tech Lead | 培训材料 | ⏳ 待开始 |

**回归测试内容**:
- 完整功能测试 (100+用例)
- 性能回归测试
- 兼容性测试 (前端、API)

---

### 📅 Week 6: 灰度发布与全量上线

#### Day 26-27 (2026-02-06 ~ 02-07 周一-周二)

**里程碑**: M6 - 灰度发布(5%)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| Day 26上午 | 灰度发布 (5%流量) | 运维F | 灰度环境 | ⏳ 待开始 |
| Day 26-27 | 监控观察 (2天) | 运维F + 测试B | 监控报告 | ⏳ 待开始 |

**监控指标**:
- 异常告警数量 (目标: 0)
- 响应时间 (目标: < 500ms)
- QPS (目标: > 1000)
- 错误率 (目标: < 0.01%)

---

#### Day 28-29 (2026-02-08 ~ 02-09 周三-周四)

| 阶段 | 时间 | 流量比例 | 观察期 |
|------|------|---------|--------|
| 灰度第二步 | Day 28 | 20% | 1天 |
| 灰度第三步 | Day 29 | 50% | 1天 |

---

#### Day 30 (2026-02-10 周五)

**里程碑**: M7 - 全量上线

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | 上线评审会议 | 全员 | 评审纪要 | ⏳ 待开始 |
| 10:00-12:00 | 全量上线 (100%流量) | 运维F | 生产环境 | ⏳ 待开始 |
| 14:00-18:00 | 持续监控 (4小时) | 运维F + 开发A | 监控报告 | ⏳ 待开始 |

**上线验收标准**:
- ✅ 灰度期间无严重Bug
- ✅ 性能指标达标
- ✅ 安全测试通过
- ✅ 产品验收通过

---

## 三、关键里程碑总览

| 里程碑 | 日期 | 交付物 | 验收标准 | 负责人 |
|-------|------|--------|---------|--------|
| **M1: 需求评审通过** | Day 1<br>(01-06) | 评审纪要 | 产品+技术签字 | 产品经理 |
| **M2: 技术方案评审通过** | Day 2<br>(01-07) | 技术设计文档 | Tech Lead签字 | Tech Lead |
| **M3: P0级Bug修复完成** | Day 10<br>(01-17) | 代码+测试报告 | 集成测试通过 | 开发A |
| **M4: P1级问题修复完成** | Day 22<br>(02-02) | 代码+性能报告 | 性能测试通过 | 开发A |
| **M5: P2级优化完成** | Day 25<br>(02-05) | 代码+回归报告 | 回归测试通过 | 开发A |
| **M6: 灰度发布(5%)** | Day 26<br>(02-06) | 灰度环境 | 监控无告警 | 运维F |
| **M7: 全量上线** | Day 30<br>(02-10) | 生产环境 | 验收通过 | 运维F |

---

## 四、风险与应对

### 4.1 进度风险

| 风险 | 概率 | 影响 | 应对措施 |
|------|-----|-----|---------|
| **需求理解偏差** | 中 | 高 | Day 1需求评审会议充分讨论 |
| **技术难度超预期** | 中 | 中 | 预留4天缓冲时间 |
| **测试发现严重Bug** | 中 | 高 | 每阶段预留Bug修复时间 |
| **DBA资源不足** | 中 | 中 | Day 16提前预约DBA时间 |
| **安全测试排期紧张** | 高 | 中 | Day 13提前1周申请安全测试 |

### 4.2 关键决策点

| 决策点 | 时间 | 决策内容 | 决策者 |
|-------|------|---------|--------|
| **价格快照是否实施** | Day 1 | 建议暂不实施,单独立项 | 产品经理 |
| **Redis缓存过期时间** | Day 12 | 设置为5分钟 | Tech Lead |
| **灰度发布是否继续** | Day 26-29 | 每步根据监控数据决策 | 运维F + Tech Lead |

---

## 五、项目看板 (Kanban)

### 5.1 待办 (TODO)

- [ ] Day 1: 需求评审会议
- [ ] Day 1-2: 技术方案设计
- [ ] Day 2: 设计评审会议
- [ ] Day 2: 搭建测试环境

### 5.2 进行中 (IN PROGRESS)

_当前无任务_

### 5.3 已完成 (DONE)

_当前无任务_

### 5.4 已阻塞 (BLOCKED)

_当前无任务_

---

## 六、每日站会议题

### 建议议题

1. **昨天完成了什么?**
2. **今天计划做什么?**
3. **遇到什么阻塞?**
4. **需要谁的帮助?**

### 站会时间

- **时间**: 每天 09:30-09:45 (15分钟)
- **参与人**: 全员
- **形式**: 线下/线上会议

---

## 七、周报模板

### Week N 周报

**本周目标**: 
- 阶段X的任务

**完成情况**:
- ✅ 已完成: XXX
- ⏳ 进行中: XXX
- ❌ 未完成: XXX

**下周计划**:
- 计划1
- 计划2

**风险与问题**:
- 风险1: XXX
- 问题1: XXX

**需要协调**:
- XXX资源

---

## 八、版本信息

| 项目 | 内容 |
|------|------|
| **文档版本** | v1.0 |
| **创建时间** | 2026-01-02 |
| **创建人员** | 产品 + 技术团队 |
| **最后更新** | 2026-01-02 |
| **文档状态** | ✅ 待评审 |

---

## 附录A: 快速查询

### A.1 按优先级查询

- **P0级Bug** (4个): Day 2-10 完成
- **P1级问题** (6个): Day 11-22 完成
- **P2级优化** (5个): Day 23-25 完成

### A.2 按负责人查询

- **产品经理**: Day 1 (需求评审), Day 30 (产品验收)
- **Tech Lead**: Day 1-2 (技术设计), Day 6-7 (代码审查), Day 12 (价格验证设计)
- **开发A**: Day 2-10 (P0开发), Day 11-25 (P1+P2开发)
- **开发C**: Day 15 (Redis缓存开发)
- **测试B**: Day 8-9 (P0测试), Day 18-19 (性能测试), Day 24-25 (回归测试)
- **安全D**: Day 20-21 (安全测试)
- **DBA**: Day 16 (索引评审与添加)
- **运维F**: Day 2 (测试环境), Day 25 (灰度方案), Day 26-30 (灰度发布)

### A.3 按文件查询

- **OmsPromotionServiceImpl.java** (274行): Day 2-25 持续修复
- **OmsCartItemServiceImpl.java** (140行): Day 13-14 价格验证
- **OmsCartItemController.java** (112行): Day 23 参数限制
- **PortalProductDao.xml** (102行): Day 16 索引优化, Day 23 排序优化

---

**文档创建**: 2026-01-02  
**下次更新**: 每日站会后更新进度  
**审批状态**: ✅ 待评审
