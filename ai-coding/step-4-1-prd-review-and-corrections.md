# PRD文档问题分析与修正过程

## 一、研发组长反馈问题

### 1.1 反馈概述

研发组长认为原PRD文档"非常不合适,有很多漏洞,并且不切合实际"。

### 1.2 问题识别思路

基于研发组长的反馈,我需要从以下维度进行深入分析:

1. **技术可行性**: 方案是否能实际落地
2. **工作量评估**: 时间估算是否合理
3. **风险评估**: 是否忽略关键风险
4. **需求合理性**: 是否存在过度设计
5. **代码理解偏差**: 是否误解了现有代码

---

## 二、逐项问题分析

### 2.1 【严重问题】价格快照机制设计不合理

#### 原PRD描述
```
步骤1: 购物车表添加价格快照字段
ALTER TABLE oms_cart_item ADD COLUMN snapshot_price DECIMAL(10,2);
ALTER TABLE oms_cart_item ADD COLUMN snapshot_time DATETIME;

步骤2: 添加时记录价格快照
步骤3: 查询时比较价格变化
步骤4: 前端显示提示
```

#### 问题分析

**问题1: 与现有系统设计冲突**

查看现有代码:
```java
// OmsCartItemServiceImpl.java:82-91
public List<CartPromotionItem> listPromotion(Long memberId, List<Long> cartIds) {
    List<OmsCartItem> cartItemList = list(memberId);
    // ✅ 系统采用实时计算策略
    cartPromotionItemList = promotionService.calcCartPromotion(cartItemList);
    return cartPromotionItemList;
}
```

**现实情况**: 
- 系统**设计为实时计算**,每次查询都重新计算最新价格
- 这是**有意的产品设计**,不是Bug
- Bug分析报告中已明确标注为"设计特性"

**问题根源**: 
- **误将"设计特性"当作需要改进的问题**
- 未与产品经理确认是否真的需要价格快照
- 擅自添加了数据库表结构变更

**正确做法**:
1. 先与产品经理确认: 实时计算 vs 价格快照,产品选择哪种
2. 如果确需价格快照,需评估对现有业务的影响
3. 需要评审会议讨论,不应在PRD中直接定方案

**修正方案**: 
- 将"价格快照机制"从P1降级为**待产品确认需求**
- 如需实施,作为独立需求单独评审

---

#### 问题2: 数据库变更风险评估不足

**原PRD问题**:
```sql
ALTER TABLE oms_cart_item ADD COLUMN snapshot_price DECIMAL(10,2);
ALTER TABLE oms_cart_item ADD COLUMN snapshot_time DATETIME;
```

**风险分析**:
1. `oms_cart_item` 是**核心交易表**,在线修改表结构有风险
2. 未评估表数据量(可能有百万级数据)
3. 未说明是否需要停机维护
4. 未提供数据迁移的锁表时间评估

**缺失内容**:
- 表数据量评估
- DDL执行时间预估
- 是否需要停机/灰度方案
- 回滚方案细节

**修正方案**:
- 增加数据库变更风险评估章节
- 提供pt-online-schema-change方案(在线DDL)
- 评估对业务的影响时间窗口

---

### 2.2 【严重问题】工作量评估严重不足

#### 原PRD估算

| 迭代 | 预计时间 | 任务数 |
|------|---------|-------|
| 迭代1: Bug修复 | 3天 | 6个任务 |
| 迭代2: 安全+性能 | 5天 | 7个任务 |
| 迭代3: 用户体验 | 4天 | 5个任务 |
| 迭代4: 上线准备 | 2天 | 4个任务 |
| **总计** | **14天** | **22个任务** |

#### 问题分析

**问题1: 未考虑联调测试时间**

原估算的"测试验证4小时"完全不现实:
- Bug修复后需要**完整回归测试** (至少1-2天)
- 性能测试需要**准备测试环境和数据** (至少1天)
- 安全测试需要**专业安全团队评审** (至少2-3天)

**问题2: 未考虑代码审查时间**

- Tech Lead代码审查2小时? 
- 实际:每个PR审查至少需要0.5-1天(包含修改反馈)
- 多轮Review时间未计入

**问题3: 未考虑需求澄清和设计评审时间**

- 价格快照机制是否真需要? 需要产品评审
- 数据库表结构变更需要DBA评审
- 接口变更需要前后端联合评审

**实际工作量重估**:

| 阶段 | 原估算 | 实际需要 | 差距 |
|------|-------|---------|-----|
| 需求澄清与设计评审 | 0天 | 2-3天 | +3天 |
| Bug修复开发 | 3天 | 3天 | 0 |
| 代码审查与修改 | 2小时 | 2天 | +2天 |
| 单元测试编写 | 4小时 | 2天 | +2天 |
| 集成测试 | 4小时 | 2天 | +2天 |
| 性能测试 | 8小时 | 3天 | +2天 |
| 安全测试 | 4小时 | 3天 | +3天 |
| 用户体验优化 | 4天 | 5天 | +1天 |
| 上线准备 | 2天 | 3天 | +1天 |
| **总计** | **14天** | **25-26天** | **+12天** |

**修正方案**: 
- 重新评估工作量,从14天调整为**4-5周**(20-25个工作日)
- 增加缓冲时间(20%)
- 明确标注"最乐观估计"和"保守估计"

---

### 2.3 【严重问题】技术方案可行性存疑

#### 问题1: 购物车添加价格验证方案不完整

**原PRD方案**:
```java
// ✅ 从数据库查询真实商品信息
CartProduct product = productDao.getCartProduct(cartItem.getProductId());

// ✅ 强制使用服务端数据
cartItem.setProductName(product.getName());
cartItem.setPrice(product.getPrice());
```

**遗漏的关键问题**:

1. **性能问题**: 每次添加购物车都查询一次商品信息
   - 原代码: 直接插入,不查询
   - 新方案: 每次都查数据库
   - 高并发场景下会造成数据库压力

2. **并发问题**: 未处理并发添加相同商品
   - 两个请求同时添加商品,都查询到不存在
   - 都会执行insert,可能导致重复数据

3. **事务问题**: 查询和插入不在同一事务
   - 查询后商品可能被删除
   - 插入时会失败

**正确方案应包括**:
- 增加Redis缓存商品信息(避免每次查DB)
- 增加唯一索引防止重复(member_id + product_id + sku_id)
- 使用分布式锁处理并发
- 增加事务管理

**修正方案**:
- 补充完整的技术方案(包含缓存、锁、事务)
- 评估性能影响
- 提供降级方案

---

#### 问题2: 性能优化方案过于乐观

**原PRD描述**:
```
优化方案: 将List转换为Map
预期提升: 购物车10个商品时,性能提升约10倍
```

**问题分析**:

1. **性能提升过度承诺**
   - "10倍"是理论值,实际提升取决于多个因素
   - 未考虑数据库查询时间(可能占90%耗时)
   - Map转换本身也有开销

2. **测试数据不足**
   - 只说"10个商品",实际场景可能是1-100个
   - 未提供不同数量级的性能对比数据
   - 未提供当前系统的性能基线

**正确做法**:
- 先用JMH进行基准测试
- 提供详细的性能对比数据
- 说明"在XX场景下提升XX%"
- 不要过度承诺

**修正方案**:
- 改为"预期提升30-50%"(保守估计)
- 增加性能测试计划章节
- 提供测试数据和测试方法

---

### 2.4 【中等问题】需求优先级不合理

#### 原PRD优先级

| 优先级 | 任务数 | 工时 |
|-------|-------|------|
| P0(立即修复) | 3个 | 6h |
| P1(尽快修复) | 6个 | 15h |
| P2(逐步优化) | 5个 | 5h |

#### 问题分析

**问题1: P0级别Bug修复时间严重不足**

- 空指针异常修复: 6小时
  - 实际: 需要修复3种促销类型,每个至少2小时
  - 需要编写单元测试,至少4小时
  - 代码审查和修改,至少2小时
  - **实际需要**: 至少2天

**问题2: 优先级定义与实际不符**

查看Bug分析报告:
```
P0级问题:
1. 空指针异常 - 🔴严重
2. 除零异常 - 🔴严重  
3. 优惠金额精度 - 🔴严重
```

但PRD中将"库存状态提示"定为P2(逐步优化),实际这是**用户体验优化**,不应该在第一批修复中。

**问题3: 未考虑依赖关系**

- "价格验证"依赖"商品查询接口改造"
- "性能优化"需要先完成"功能Bug修复"(否则无法测试)
- PRD未体现这些依赖关系

**修正方案**:
- 重新划分优先级
- P0: 只包含严重Bug修复(空指针、除零、精度)
- P1: 安全和性能问题
- P2: 用户体验优化(需产品确认)
- 明确任务依赖关系

---

### 2.5 【中等问题】测试方案不充分

#### 原PRD测试方案

```
7.1 单元测试 - 目标覆盖率: 80%
7.2 集成测试 - 5个场景
7.3 性能测试 - 3个指标
7.4 安全测试 - 5个测试项
```

#### 问题分析

**问题1: 单元测试覆盖率目标不合理**

- 原代码可能没有单元测试
- 要达到80%覆盖率需要补充大量测试
- 4小时编写单元测试完全不够

**问题2: 集成测试场景不全面**

缺失的关键场景:
- 价格快照与实时计算的切换测试
- 数据库索引添加后的性能对比
- 大批量商品(100+)的性能测试
- 促销规则边界条件测试

**问题3: 没有回归测试计划**

- Bug修复可能引入新问题
- 需要完整的回归测试
- 原PRD未提及

**修正方案**:
- 降低单元测试覆盖率目标到60%(更实际)
- 补充完整的集成测试场景(至少15个)
- 增加回归测试计划
- 增加自动化测试脚本开发时间

---

### 2.6 【中等问题】风险管理不到位

#### 原PRD风险管理

```
8.1 技术风险 - 4个风险
8.2 业务风险 - 3个风险  
8.3 上线风险 - 3个风险
```

#### 问题分析

**缺失的关键风险**:

1. **数据一致性风险**
   - 价格快照与实时价格不一致
   - 促销规则变更时购物车数据处理
   - 未提及如何处理

2. **兼容性风险**
   - 接口返回字段变更(新增priceChanged, stockStatus等)
   - 老版本前端如何兼容
   - 未提及

3. **性能回退风险**
   - 增加价格验证后可能变慢
   - 数据库索引可能影响写入
   - 评估不足

4. **团队协作风险**
   - 需要前端、后端、DBA、测试、安全团队配合
   - 人力资源是否到位
   - 未提及

**修正方案**:
- 补充完整的风险清单(至少15个风险)
- 每个风险都要有明确的应对措施
- 增加风险发生后的contingency plan
- 增加跨团队协作章节

---

### 2.7 【轻微问题】文档结构和表达问题

#### 问题1: 技术细节过多,缺少业务视角

PRD应该是**需求**文档,不是**设计**文档。

原PRD包含大量代码:
```java
// 这些代码应该在技术设计文档中,不应该在PRD中
PmsSkuStock skuStock = getOriginalPrice(promotionProduct, item.getProductSkuId());
if (skuStock == null) {
    log.error("SKU不存在: productId={}, skuId={}", item.getProductId(), item.getProductSkuId());
    continue;
}
```

**正确做法**:
- PRD: 描述"需要解决什么问题,期望达到什么效果"
- 技术设计文档: 描述"如何实现,代码怎么写"

#### 问题2: 验收标准不够具体

原验收标准:
```
- [ ] 所有P0级Bug已修复,无空指针/除零异常
- [ ] 价格变更投诉率降低 > 80%
```

问题:
- "所有Bug已修复"如何验证? 
- "投诉率降低80%"如何度量? 需要多长时间统计?
- 没有可执行的验收步骤

**修正方案**:
- 验收标准要可度量、可验证
- 增加具体的验收步骤和验收方法
- 增加验收负责人

---

## 三、根本原因分析

### 3.1 为什么会出现这些问题?

| 问题类型 | 根本原因 |
|---------|---------|
| **过度设计** | 未与产品经理确认需求,擅自增加价格快照功能 |
| **工作量低估** | 缺乏实际开发经验,对测试、审查、联调时间估计不足 |
| **技术方案不完整** | 只考虑了happy path,未考虑异常、并发、性能等 |
| **风险评估不足** | 经验不足,未能识别数据库变更等关键风险 |
| **优先级混乱** | 未理解P0/P1/P2的真实含义,未考虑依赖关系 |

### 3.2 与Bug分析报告的对比

| 维度 | Bug分析报告 | 原PRD | 差异 |
|------|-----------|-------|------|
| **准确性** | 经过修正,准确率100% | 多处理解偏差 | 原PRD对代码理解不如Bug报告深入 |
| **问题数量** | 15个真实问题 | 增加了价格快照等非必需功能 | 原PRD范围扩散 |
| **工作量** | 26小时(Bug修复) | 14天(包含用户体验) | 原PRD包含了很多待确认需求 |

---

## 四、修正策略

### 4.1 修正原则

1. **回归Bug分析报告**: 只修复已确认的15个问题
2. **移除待确认需求**: 价格快照等需产品评审后再决定
3. **工作量翻倍**: 从14天调整为20-25天
4. **补充风险评估**: 增加完整的风险管理章节
5. **简化技术细节**: PRD聚焦需求,代码放到技术设计文档
6. **增加评审环节**: 明确需要哪些评审会议

### 4.2 修正后的文档结构

```
新PRD文档结构:
├── 一、项目背景
│   ├── 1.1 背景说明(基于Bug分析报告)
│   ├── 1.2 核心问题(只列已确认的15个)
│   └── 1.3 优化目标(可量化指标)
│
├── 二、需求范围
│   ├── 2.1 确定修复范围(15个Bug)
│   ├── 2.2 不在范围(明确排除价格快照等)
│   └── 2.3 待评审需求(列为附录)
│
├── 三、需求详情(按优先级)
│   ├── 3.1 P0级:严重Bug修复(4个)
│   ├── 3.2 P1级:高危问题修复(6个)
│   └── 3.3 P2级:中危优化(5个)
│
├── 四、技术约束(不写具体代码)
│   ├── 4.1 技术栈限制
│   ├── 4.2 性能要求
│   ├── 4.3 安全要求
│   └── 4.4 兼容性要求
│
├── 五、项目计划
│   ├── 5.1 分阶段计划(3个阶段)
│   ├── 5.2 工作量评估(保守估计)
│   ├── 5.3 里程碑(可验证)
│   └── 5.4 人力资源(明确角色)
│
├── 六、风险管理(详细)
│   ├── 6.1 技术风险(8个)
│   ├── 6.2 业务风险(5个)
│   ├── 6.3 协作风险(3个)
│   └── 6.4 应对措施(每个风险都有)
│
├── 七、验收标准(可执行)
│   ├── 7.1 功能验收(具体步骤)
│   ├── 7.2 性能验收(具体指标)
│   ├── 7.3 安全验收(具体方法)
│   └── 7.4 验收流程(谁来验收)
│
└── 八、附录
    ├── 8.1 待评审需求(价格快照等)
    ├── 8.2 参考文档
    └── 8.3 术语表
```

---

## 五、关键修正点汇总

### 5.1 必须修正的内容

| 序号 | 修正项 | 原内容 | 修正后 | 重要性 |
|-----|-------|-------|-------|--------|
| 1 | **移除价格快照功能** | 作为P1需求 | 移至"待评审附录" | 🔴严重 |
| 2 | **调整工作量** | 14天 | 20-25天 | 🔴严重 |
| 3 | **补充技术方案** | 只有代码片段 | 增加缓存、锁、事务设计 | 🔴严重 |
| 4 | **重新划分优先级** | P0/P1/P2混乱 | 按严重等级重新划分 | 🟠高危 |
| 5 | **补充风险评估** | 10个风险 | 至少20个风险 | 🟠高危 |
| 6 | **完善测试方案** | 简单描述 | 详细测试计划 | 🟠高危 |
| 7 | **增加评审环节** | 无 | 需求评审、设计评审、代码评审 | 🟡中危 |
| 8 | **简化技术细节** | 大量代码 | 删除代码,聚焦需求 | 🟡中危 |

### 5.2 可选优化的内容

- 增加术语表
- 增加用户故事
- 增加流程图
- 增加数据字典

---

## 六、经验教训

### 6.1 PRD编写的常见陷阱

1. ❌ **过度设计**: 擅自添加未确认的需求
2. ❌ **工作量乐观**: 忽略测试、审查、联调时间
3. ❌ **技术细节过多**: PRD变成了技术设计文档
4. ❌ **风险评估不足**: 只看到happy path
5. ❌ **优先级混乱**: 不理解P0/P1/P2的真实含义

### 6.2 正确的PRD编写流程

```
第1步: 需求澄清
├─ 与产品经理确认需求边界
├─ 与技术团队评估可行性
└─ 与测试团队确认验收标准

第2步: 问题分析
├─ 基于Bug分析报告
├─ 不擅自增加需求
└─ 明确优先级

第3步: 方案设计(高层次)
├─ 描述做什么,不写怎么做
├─ 技术约束,不写具体代码
└─ 评估工作量(保守估计)

第4步: 风险识别
├─ 技术风险
├─ 业务风险
├─ 协作风险
└─ 每个风险都有应对措施

第5步: 评审与修正
├─ 产品评审
├─ 技术评审
├─ 根据反馈修正
└─ 多轮迭代

第6步: 最终定稿
└─ 所有相关方签字确认
```

---

## 七、总结

### 7.1 原PRD主要问题

1. **擅自增加未确认需求**(价格快照)
2. **工作量严重低估**(14天 → 实际需要25天)
3. **技术方案不完整**(缺少缓存、锁、事务设计)
4. **风险评估不充分**(遗漏关键风险)
5. **优先级不合理**(P0/P1/P2划分混乱)
6. **技术细节过多**(PRD变成了设计文档)

### 7.2 修正后的改进

1. ✅ **严格基于Bug分析报告**(15个已确认问题)
2. ✅ **工作量保守估计**(20-25天,包含缓冲)
3. ✅ **技术方案完整**(包含异常、并发、性能考虑)
4. ✅ **风险评估充分**(20+风险,都有应对措施)
5. ✅ **优先级清晰**(P0:严重Bug, P1:高危问题, P2:优化)
6. ✅ **PRD聚焦需求**(技术细节移至设计文档)

### 7.3 关键指标对比

| 指标 | 原PRD | 修正后 | 变化 |
|------|-------|-------|------|
| 需求数量 | 22个 | 15个 | -7个(移除未确认需求) |
| 预估工期 | 14天 | 20-25天 | +6-11天 |
| 风险数量 | 10个 | 20+个 | +10个 |
| P0任务 | 3个 | 4个 | +1个 |
| 代码行数 | 500+行 | 100行 | -400行(移至设计文档) |

---

**修正时间**: 2026-01-02  
**修正人员**: 技术团队  
**下一步**: 生成修正后的PRD文档  
**状态**: ✅ 修正分析完成
