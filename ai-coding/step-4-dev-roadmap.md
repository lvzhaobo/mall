# mall电商系统 - 价格体系优化 Roadmap (原始PRD版)

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 价格体系优化项目路线图 |
| **文档版本** | v1.0 |
| **创建时间** | 2026-01-02 |
| **项目周期** | 14个工作日 (3周) |
| **关联文档** | [原始PRD](./step-4-dev.md) |

---

## 一、项目总览

### 1.1 时间线概览

```
Week 1              Week 2              Week 3
├───────────────────┼───────────────────┼───────────────────┤
│  迭代1: Bug修复   │  迭代2: 安全+性能  │  迭代3: 体验优化  │
│  (3天)           │  (5天)            │  (4天) + 上线(2天)│
└───────────────────┴───────────────────┴───────────────────┘
  M1                 M2    M3            M4    M5       M6
```

### 1.2 项目目标

| 维度 | 当前状态 | 目标状态 | 度量指标 |
|------|---------|---------|---------|
| **稳定性** | 🔴 存在空指针/除零异常 | 🟢 系统崩溃率降低100% | 生产环境0异常 |
| **准确性** | 🔴 精度问题 | 🟢 100%准确 | 财务对账一致 |
| **性能** | 🟡 响应慢(~1s) | 🟢 < 500ms | 95th百分位 |
| **安全性** | 🟡 价格篡改风险 | 🟢 无高危漏洞 | 通过安全审计 |
| **用户体验** | 🔴 价格变化投诉高 | 🟢 投诉率降低80% | 用户满意度>90% |

### 1.3 核心优化内容

| 类型 | 数量 | 优先级分布 |
|------|-----|-----------|
| Bug修复 | 5个 | P0: 3个, P1: 2个 |
| 安全增强 | 2个 | P1: 1个, P2: 1个 |
| 性能优化 | 3个 | P1: 2个, P2: 1个 |
| 体验优化 | 2个 | P1: 1个, P2: 1个 |

---

## 二、详细Roadmap

### 📅 迭代1: Bug修复 (Day 1-3)

**目标**: 消除所有严重Bug,系统崩溃率降低100%

#### Day 1 (2026-01-06 周一)

**里程碑**: M1 - 项目启动与方案设计

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | Kick-off会议 | 产品+技术团队 | 会议纪要 | ⏳ 待开始 |
| 10:00-12:00 | 技术方案设计 | Tech Lead | 技术方案文档 | ⏳ 待开始 |
| 14:00-16:00 | 方案评审会议 | 技术团队 | 评审纪要 | ⏳ 待开始 |
| 16:00-18:00 | 环境准备 + 代码开发(启动) | 开发A | 开发环境 | ⏳ 待开始 |

**关键决策点**:
- ✅ 确认优惠金额分摊采用"最后补齐差额"算法
- ✅ 确认BigDecimal精度统一为2位小数
- ✅ 确认价格快照机制是否实施

---

#### Day 2 (2026-01-07 周二)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| **上午** | **P0-1: 空指针异常修复** | 开发A | | |
| 09:00-12:00 | - 修复3种促销类型的空指针<br>- 添加null检查和日志<br>- 编写单元测试 | 开发A | 代码+测试 | ⏳ 待开始 |
| **下午** | **P0-2: 满减除零异常修复** | 开发A | | |
| 14:00-16:00 | - 添加零值检查<br>- 降级处理逻辑<br>- 编写单元测试 | 开发A | 代码+测试 | ⏳ 待开始 |
| 16:00-18:00 | **P0-3: 优惠金额分摊精度修复(启动)** | 开发A | 代码框架 | ⏳ 待开始 |

**开发内容**:
```java
// 1. 空指针异常修复
if (skuStock == null) {
    log.error("SKU不存在: productId={}, skuId={}", ...);
    continue;
}

// 2. 除零异常修复
if (totalAmount.compareTo(BigDecimal.ZERO) == 0) {
    log.error("满减优惠计算异常: 总金额为0");
    handleNoReduce(...);
    continue;
}
```

---

#### Day 3 (2026-01-08 周三)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | **P0-3: 优惠金额分摊精度修复(完成)** | 开发A | 代码+测试 | ⏳ 待开始 |
| 14:00-16:00 | 代码审查(第1轮) | Tech Lead | 审查意见 | ⏳ 待开始 |
| 16:00-18:00 | 代码修改(审查意见) | 开发A | 修改后代码 | ⏳ 待开始 |

**开发内容**:
```java
// 最后补齐差额算法
for (int i = 0; i < itemList.size(); i++) {
    if (i == itemList.size() - 1) {
        // 最后一个商品补齐差额
        reduceAmount = fullReduction.getReducePrice().subtract(totalReduce);
    } else {
        // 按比例分摊
        reduceAmount = originalPrice
            .divide(totalAmount, 2, RoundingMode.HALF_EVEN)
            .multiply(fullReduction.getReducePrice());
        totalReduce = totalReduce.add(reduceAmount);
    }
}
```

**验收标准**:
- ✅ 3个P0级Bug全部修复
- ✅ 单元测试覆盖率 > 80%
- ✅ 代码审查通过

---

### 📅 迭代2: 安全增强 + 性能优化 (Day 4-8)

**目标**: 通过安全审计,响应时间 < 500ms

#### Day 4 (2026-01-09 周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | **P1-1: 满减规则精度修复** | 开发A | 代码+测试 | ⏳ 待开始 |
| 14:00-18:00 | **P1-2: 阶梯排序整数溢出修复** | 开发A | 代码+测试 | ⏳ 待开始 |

**开发内容**:
```java
// 1. 满减规则精度修复
fullReductionList.sort((o1, o2) -> 
    o2.getFullPrice().compareTo(o1.getFullPrice())  // ✅ 使用compareTo()
);

// 2. 阶梯排序优化
productLadderList.sort(
    Comparator.comparingInt(PmsProductLadder::getCount).reversed()
);
```

---

#### Day 5 (2026-01-10 周五)

**里程碑**: M2 - Bug修复完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | 集成测试(Bug修复) | 测试B | 测试报告 | ⏳ 待开始 |
| 14:00-16:00 | Bug修复(测试反馈) | 开发A | Bug修复 | ⏳ 待开始 |
| 16:00-18:00 | 里程碑评审 | 全员 | 评审纪要 | ⏳ 待开始 |

**验收标准**:
- ✅ 5个Bug全部修复
- ✅ 单元测试覆盖率 > 80%
- ✅ 集成测试通过率 = 100%

---

#### Day 6 (2026-01-13 周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| **全天** | **P1-3: 购物车添加价格验证** | 开发A | | |
| 09:00-12:00 | - 从数据库查询真实商品信息<br>- 强制使用服务端价格<br>- 验证SKU和库存 | 开发A | 代码框架 | ⏳ 待开始 |
| 14:00-18:00 | - 完成业务逻辑<br>- 编写单元测试 | 开发A | 代码+测试 | ⏳ 待开始 |

**开发内容**:
```java
// 从数据库查询真实商品信息
CartProduct product = productDao.getCartProduct(cartItem.getProductId());
if (product == null) {
    throw new ApiException("商品不存在");
}

// 强制使用服务端数据
cartItem.setProductName(product.getName());
cartItem.setPrice(product.getPrice());
```

---

#### Day 7 (2026-01-14 周二)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | **P1-4: 促销商品查找优化** | 开发C | 代码+测试 | ⏳ 待开始 |
| 14:00-18:00 | **P1-5: 数据库索引优化** | DBA | 索引脚本 | ⏳ 待开始 |

**性能优化内容**:

1. **Map优化** (开发C):
```java
// 转换为Map,查找复杂度O(1)
Map<Long, PromotionProduct> promotionProductMap = promotionProductList.stream()
    .collect(Collectors.toMap(PromotionProduct::getId, p -> p));

// O(N×M) → O(N+M)
PromotionProduct promotionProduct = promotionProductMap.get(productId);
```

2. **数据库索引** (DBA):
```sql
ALTER TABLE pms_sku_stock ADD INDEX idx_product_id (product_id);
ALTER TABLE pms_product_ladder ADD INDEX idx_product_id (product_id);
ALTER TABLE pms_product_full_reduction ADD INDEX idx_product_id (product_id);
```

---

#### Day 8 (2026-01-15 周三)

**里程碑**: M3 - 性能优化完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | 性能测试 | 测试B | 性能报告 | ⏳ 待开始 |
| 14:00-16:00 | 安全测试 | 安全D | 安全报告 | ⏳ 待开始 |
| 16:00-18:00 | 里程碑评审 | 全员 | 评审纪要 | ⏳ 待开始 |

**性能测试目标**:

| 指标 | 当前值 | 目标值 | 测试方法 |
|------|-------|--------|---------|
| 购物车查询响应时间 | ~1000ms | < 500ms | JMeter 1000并发 |
| 促销计算时间 | ~500ms | < 200ms | 方法级监控 |
| 数据库查询时间 | ~300ms | < 100ms | Slow Query Log |
| 并发QPS | ~500 | > 1000 | JMeter压力测试 |

**安全测试内容**:
- 价格篡改测试 (客户端传入0.01元)
- SQL注入测试
- 越权访问测试
- XSS攻击测试

**验收标准**:
- ✅ 响应时间 < 500ms
- ✅ QPS > 1000
- ✅ 无高危安全漏洞

---

### 📅 迭代3: 用户体验优化 (Day 9-12)

**目标**: 价格变更投诉率降低80%

#### Day 9 (2026-01-16 周四)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | 数据库表结构变更(评审) | DBA | 变更方案 | ⏳ 待开始 |
| 10:00-11:00 | 数据库表结构变更(执行) | DBA | 变更完成 | ⏳ 待开始 |
| 11:00-12:00 | 数据迁移 | DBA | 迁移完成 | ⏳ 待开始 |
| 14:00-18:00 | **P1-6: 价格快照机制(启动)** | 开发A | 代码框架 | ⏳ 待开始 |

**数据库变更**:
```sql
-- 添加价格快照字段
ALTER TABLE oms_cart_item 
ADD COLUMN snapshot_price DECIMAL(10,2) DEFAULT NULL COMMENT '价格快照',
ADD COLUMN snapshot_time DATETIME DEFAULT NULL COMMENT '快照时间';

-- 数据迁移
UPDATE oms_cart_item c
INNER JOIN pms_product p ON c.product_id = p.id
SET c.snapshot_price = c.price,
    c.snapshot_time = c.create_date
WHERE c.snapshot_price IS NULL;
```

---

#### Day 10 (2026-01-17 周五)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| **全天** | **P1-6: 价格快照机制(完成)** | 开发A | | |
| 09:00-12:00 | - 添加时记录价格快照<br>- 查询时比较价格变化<br>- 添加变更提示字段 | 开发A | 代码+测试 | ⏳ 待开始 |
| 14:00-18:00 | **P2-1: 库存状态友好提示** | 开发A | 代码+测试 | ⏳ 待开始 |

**开发内容**:
```java
// 1. 记录价格快照
cartItem.setPrice(product.getPrice());
cartItem.setSnapshotPrice(product.getPrice());
cartItem.setSnapshotTime(new Date());

// 2. 检查价格变化
if (currentPrice.compareTo(snapshotPrice) != 0) {
    item.setPriceChanged(true);
    item.setOldPrice(snapshotPrice);
    item.setWarningMessage(String.format(
        "价格已从%.2f元变更为%.2f元", 
        snapshotPrice, currentPrice
    ));
}

// 3. 库存状态提示
if (realStock == 0) {
    cartPromotionItem.setStockStatus("OUT_OF_STOCK");
    cartPromotionItem.setStockMessage("商品已售罄");
} else if (realStock < 10) {
    cartPromotionItem.setStockStatus("LOW_STOCK");
    cartPromotionItem.setStockMessage(String.format("库存紧张,仅剩%d件", realStock));
}
```

---

#### Day 11 (2026-01-20 周一)

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | **前端页面改造** | 前端E | 前端代码 | ⏳ 待开始 |
| 14:00-18:00 | **P2-2: IN查询参数数量限制** | 开发A | 代码+测试 | ⏳ 待开始 |

**前端改造内容**:
```vue
<!-- 价格变更提示 -->
<div v-if="item.priceChanged" class="price-warning">
  <i class="el-icon-warning"></i>
  <span>{{ item.warningMessage }}</span>
</div>

<!-- 库存状态提示 -->
<div class="stock-info" :class="item.stockStatus">
  {{ item.stockMessage }}
</div>
```

---

#### Day 12 (2026-01-21 周二)

**里程碑**: M4 - 用户体验优化完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | **P2-3: 数据库排序优化** | 开发A | SQL优化 | ⏳ 待开始 |
| 10:00-12:00 | 前后端联调 | 开发A + 前端E | 联调完成 | ⏳ 待开始 |
| 14:00-18:00 | 集成测试 | 测试B | 测试报告 | ⏳ 待开始 |

**验收标准**:
- ✅ 价格快照功能正常
- ✅ 价格变更提示正常显示
- ✅ 库存状态提示正常显示
- ✅ 前后端联调成功
- ✅ 集成测试通过

---

### 📅 迭代4: 上线准备 (Day 13-14)

**目标**: 灰度发布成功,监控正常

#### Day 13 (2026-01-22 周三)

**里程碑**: M5 - 上线准备完成

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-12:00 | 回归测试 | 测试B | 测试报告 | ⏳ 待开始 |
| 14:00-16:00 | 文档更新 | 开发A | 技术文档 | ⏳ 待开始 |
| 16:00-18:00 | 灰度发布方案 | 运维F | 灰度方案 | ⏳ 待开始 |

**回归测试内容**:
- 完整功能测试 (50+用例)
- 性能回归测试
- 兼容性测试

**灰度发布方案**:
- 阶段1: 内测 (1%用户, 1天)
- 阶段2: 小流量 (5%用户, 2天)
- 阶段3: 中流量 (20%用户, 3天)
- 阶段4: 大流量 (50%用户, 3天)
- 阶段5: 全量上线 (100%用户)

---

#### Day 14 (2026-01-23 周四)

**里程碑**: M6 - 全量上线

| 时间 | 任务 | 负责人 | 产出 | 状态 |
|------|------|-------|------|------|
| 09:00-10:00 | 上线评审会议 | 全员 | 评审纪要 | ⏳ 待开始 |
| 10:00-11:00 | 灰度发布(1%内测) | 运维F | 灰度环境 | ⏳ 待开始 |
| 11:00-12:00 | 监控配置 | 运维F | 监控大盘 | ⏳ 待开始 |
| 14:00-16:00 | 团队培训 | Tech Lead | 培训材料 | ⏳ 待开始 |
| 16:00-18:00 | 持续监控 | 运维F | 监控报告 | ⏳ 待开始 |

**监控指标**:
- 购物车添加成功率
- 促销计算准确率
- 价格变更提示触发率
- 接口响应时间
- 接口错误率

---

## 三、关键里程碑总览

| 里程碑 | 日期 | 交付物 | 验收标准 |
|-------|------|--------|---------|
| **M1: 项目启动** | Day 1 (01-06) | 技术方案 | Tech Lead签字 |
| **M2: Bug修复完成** | Day 5 (01-10) | 代码+测试报告 | 5个Bug全部修复 |
| **M3: 性能优化完成** | Day 8 (01-15) | 性能报告 | 响应时间 < 500ms |
| **M4: 体验优化完成** | Day 12 (01-21) | 前端页面 | 价格快照功能正常 |
| **M5: 上线准备完成** | Day 13 (01-22) | 灰度方案 | 回归测试通过 |
| **M6: 灰度发布** | Day 14 (01-23) | 生产环境 | 监控正常 |

---

## 四、工作量汇总

### 4.1 按迭代汇总

| 迭代 | 工期 | 主要任务 | 人力投入 |
|------|-----|---------|---------|
| **迭代1: Bug修复** | 3天 | 5个Bug修复 + 单元测试 | 开发A(100%) + Tech Lead(30%) |
| **迭代2: 安全+性能** | 5天 | 价格验证 + Map优化 + 索引优化 | 开发A(100%) + 开发C(50%) + DBA(20%) |
| **迭代3: 体验优化** | 4天 | 价格快照 + 库存提示 + 前端改造 | 开发A(100%) + 前端E(50%) + DBA(20%) |
| **迭代4: 上线准备** | 2天 | 回归测试 + 灰度发布 + 监控 | 测试B(100%) + 运维F(100%) |
| **总计** | **14天** | **12个优化项** | **约90人天** |

### 4.2 按角色汇总

| 角色 | 投入时间 | 工作日 | 关键产出 |
|------|---------|--------|---------|
| Tech Lead | 30% | 4.2天 | 技术方案、代码审查 |
| 开发A | 100% | 14天 | 核心开发、单元测试 |
| 开发C | 50% | 7天 | Map优化、性能优化 |
| 前端E | 50% | 7天 | 前端页面改造 |
| 测试B | 80% | 11.2天 | 测试验证 |
| 安全D | 20% | 2.8天 | 安全测试 |
| DBA | 20% | 2.8天 | 数据库优化 |
| 运维F | 30% | 4.2天 | 灰度发布 |
| **总计** | - | **53.2人天** | - |

---

## 五、风险与应对

### 5.1 进度风险

| 风险 | 概率 | 影响 | 应对措施 |
|------|-----|-----|---------|
| **价格快照开发超期** | 中 | 高 | 预留1天缓冲时间,必要时P2功能延后 |
| **数据库迁移失败** | 低 | 高 | 先在测试环境验证,准备回滚脚本 |
| **前后端联调时间不足** | 中 | 中 | 提前对齐接口,预留0.5天联调时间 |
| **性能优化效果不达标** | 中 | 中 | 准备Plan B(增加Redis缓存) |

### 5.2 关键决策点

| 决策点 | 时间 | 决策内容 | 决策者 |
|-------|------|---------|--------|
| **价格快照是否实施** | Day 1 | 建议实施,降低用户投诉 | 产品经理 |
| **优惠分摊算法选择** | Day 1 | 采用"最后补齐差额"算法 | Tech Lead |
| **灰度发布是否继续** | Day 14+ | 根据监控数据决策 | 运维F + Tech Lead |

---

## 六、每日站会议题

### 建议议题

1. **昨天完成了什么?**
2. **今天计划做什么?**
3. **遇到什么阻塞?**
4. **需要谁的帮助?**

### 站会时间

- **时间**: 每天 09:30-09:45 (15分钟)
- **参与人**: 开发A、开发C、测试B、Tech Lead
- **形式**: 线下/线上会议

---

## 七、版本信息

| 项目 | 内容 |
|------|------|
| **文档版本** | v1.0 |
| **创建时间** | 2026-01-02 |
| **基于PRD** | step-4-dev.md (原始版本) |
| **项目周期** | 14天 (3周) |
| **文档状态** | ✅ 待评审 |

---

## 附录: 快速查询

### A.1 按优先级查询

- **P0级** (3个): Day 2-3 完成 (空指针、除零、精度)
- **P1级** (5个): Day 4-12 完成 (满减精度、阶梯排序、价格验证、Map优化、价格快照)
- **P2级** (4个): Day 11-12 完成 (IN查询限制、库存提示、排序优化)

### A.2 按负责人查询

- **Tech Lead**: Day 1 (技术方案), Day 3 (代码审查), Day 14 (团队培训)
- **开发A**: Day 2-12 (核心开发), Day 13 (文档更新)
- **开发C**: Day 7 (Map优化)
- **前端E**: Day 11-12 (前端改造)
- **测试B**: Day 5 (集成测试), Day 8 (性能测试), Day 12-13 (回归测试)
- **安全D**: Day 8 (安全测试)
- **DBA**: Day 7 (索引优化), Day 9 (表结构变更)
- **运维F**: Day 13-14 (灰度发布)

### A.3 按模块查询

- **OmsPromotionServiceImpl.java**: Day 2-12 持续修复 (9个优化项)
- **OmsCartItemServiceImpl.java**: Day 6, Day 9-10 (价格验证、价格快照)
- **PortalProductDao.xml**: Day 7, Day 12 (索引优化、排序优化)
- **前端页面**: Day 11 (价格提示、库存提示)

---

**文档创建**: 2026-01-02  
**下次更新**: 每日站会后更新进度  
**审批状态**: ✅ 待评审
