# mall电商系统 - 价格体系Bug修复PRD(修正版)

## 文档信息

| 项目 | 内容 |
|------|------|
| **文档名称** | 价格体系Bug修复需求文档 |
| **文档版本** | v2.0 (修正版) |
| **创建时间** | 2026-01-02 |
| **创建人员** | 产品 + 技术团队 |
| **评审状态** | 待评审 |
| **关联文档** | [Bug分析报告(修正版)](./step-3-3-bugs-and-security-analysis-corrected.md) |

---

## 一、项目背景

### 1.1 背景说明

基于《价格体系Bug与安全漏洞分析报告(修正版)》,技术团队对mall电商系统的价格计算核心链路进行了深入分析,识别出**15个真实存在的问题**,其中包括:
- 🔴 严重Bug 4个(可能导致系统崩溃)
- 🟠 高危问题 6个(影响业务准确性)
- 🟡 中危问题 5个(性能和体验优化)

这些问题严重影响系统稳定性、数据准确性和用户体验,**需要尽快修复**。

### 1.2 核心问题

基于Bug分析报告,核心问题如下:

**功能Bug (6个)**

| 序号 | 问题 | 严重等级 | 影响 |
|-----|------|---------|------|
| 1 | 空指针异常风险 | 🔴严重 | 用户查看购物车时系统崩溃 |
| 2 | 满减除零异常 | 🔴严重 | 促销功能不可用 |
| 3 | handleNoReduce未设置默认库存 | 🔴严重 | 前端显示null |
| 4 | 满减规则精度丢失 | 🟠高危 | 选择错误的促销规则 |
| 5 | 阶梯排序整数溢出 | 🟠高危 | 大数值时排序错误 |
| 6 | 库存计算负数 | 🟡中危 | 显示负库存 |

**安全风险 (3个)**

| 序号 | 问题 | 严重等级 | 影响 |
|-----|------|---------|------|
| 1 | 购物车添加未验证价格 | 🟠高危 | 价格可能被恶意篡改 |
| 2 | IN查询参数数量未限制 | 🟡中危 | SQL语句过长,性能问题 |

**性能问题 (4个)**

| 序号 | 问题 | 严重等级 | 影响 |
|-----|------|---------|------|
| 1 | getPromotionProductById线性查找 | 🟠高危 | O(N×M)复杂度,大批量商品慢 |
| 2 | LEFT JOIN性能问题 | 🟠高危 | 缺少索引,查询慢 |
| 3 | 重复排序操作 | 🟡中危 | Java内存排序,可优化 |
| 4 | 循环创建大量对象 | 🟡中危 | GC压力大 |

**数据一致性 (2个)**

| 序号 | 问题 | 严重等级 | 影响 |
|-----|------|---------|------|
| 1 | 优惠金额分摊精度 | 🔴严重 | 财务对账不准确 |
| 2 | 价格实时计算机制 | 🟠高危 | 用户体验差(设计特性) |

### 1.3 优化目标

| 维度 | 当前状态 | 目标状态 | 度量方式 |
|------|---------|---------|---------|
| **系统稳定性** | 存在空指针/除零异常 | 无严重异常 | 生产环境0异常告警 |
| **数据准确性** | 精度问题导致误差 | 100%准确 | 财务对账数据一致 |
| **响应性能** | 大批量商品响应慢(~1s) | < 500ms | 95th百分位响应时间 |
| **安全性** | 存在价格篡改风险 | 无高危漏洞 | 通过安全审计 |

**不包含的目标** (需产品评审后确定):
- ❌ 价格变更提示功能(与实时计算设计冲突)
- ❌ 库存状态友好提示(非核心功能)

---

## 二、需求范围

### 2.1 确定修复范围

**模块**: mall-portal (前台商城)

**涉及文件**:
- `OmsPromotionServiceImpl.java` - 促销计算核心(274行)
- `OmsCartItemServiceImpl.java` - 购物车业务逻辑(140行)
- `OmsCartItemController.java` - 购物车接口(112行)
- `PortalProductDao.xml` - 商品查询SQL(102行)

**修复内容**:
1. ✅ 修复6个功能Bug
2. ✅ 修复3个安全风险
3. ✅ 优化4个性能问题
4. ✅ 解决2个数据一致性问题

### 2.2 明确不在范围

以下内容**不在本次修复范围内**:

- ❌ 订单模块的库存扣减并发问题
- ❌ 优惠券系统的重复使用问题
- ❌ 支付模块相关问题
- ❌ 秒杀功能
- ❌ 价格变更提示功能(需产品评审)
- ❌ 库存状态友好提示(非必需)

### 2.3 待评审需求

以下需求需要**产品经理评审后**再决定是否实施:

**需求1: 价格快照机制**
- **说明**: 当前系统采用实时计算,每次查询都重新计算价格
- **问题**: 用户可能看到价格频繁变化
- **方案**: 增加价格快照,记录用户添加时的价格
- **冲突**: 与现有"实时计算"设计冲突
- **决策**: 需产品评审会议讨论
- **影响**: 如需实施,需要数据库表结构变更

**需求2: 库存状态提示**
- **说明**: 显示"库存充足"/"库存紧张"/"已售罄"等友好提示
- **优先级**: 用户体验优化,非核心功能
- **决策**: 建议在第二期实施

---

## 三、需求详情

### 3.1 【P0级】严重Bug修复

#### 3.1.1 空指针异常修复

**需求描述**

修复促销计算中的空指针异常,确保系统稳定运行。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:48-52`
- **触发条件**: SKU被删除或促销价为null
- **影响**: 用户查看购物车时系统崩溃(500错误)
- **严重等级**: 🔴严重

**需求说明**

1. 当`getOriginalPrice()`返回null时,应跳过该商品,不影响其他商品
2. 当`promotionPrice`为null时,应使用原价,不抛出异常
3. 需要记录完整的错误日志,便于排查问题
4. 所有促销类型(单品、阶梯、满减)都要处理

**验收标准**

- [ ] 测试用例: SKU不存在,购物车查询成功,异常商品被跳过
- [ ] 测试用例: 促销价为null,使用原价计算
- [ ] 日志中能看到"SKU不存在"的错误信息
- [ ] 单元测试覆盖3种促销类型的空指针场景
- [ ] 生产环境无NullPointerException告警(观察1周)

**验收人**: QA团队

---

#### 3.1.2 满减除零异常修复

**需求描述**

修复满减优惠计算中的除零异常。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:94`
- **触发条件**: 商品总金额为0时计算满减
- **影响**: 满减促销功能完全不可用
- **严重等级**: 🔴严重

**需求说明**

1. 在除法运算前检查`totalAmount`是否为0
2. 如果为0,按"无促销"处理,不抛出异常
3. 记录错误日志,标注异常商品ID
4. 需要测试边界场景(0.01元等极小金额)

**验收标准**

- [ ] 测试用例: 商品总价为0,按无促销处理
- [ ] 测试用例: 商品总价为0.01元,正常计算
- [ ] 日志中能看到"总金额为0"的错误信息
- [ ] 单元测试包含边界值场景
- [ ] 生产环境无ArithmeticException告警(观察1周)

**验收人**: QA团队

---

#### 3.1.3 优惠金额分摊精度修复

**需求描述**

修复满减金额分摊的精度问题,确保财务对账准确。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:94`
- **触发条件**: 多个商品分摊满减金额时累加有误差
- **影响**: 财务对账数据不准确,可能多退或少退
- **严重等级**: 🔴严重

**需求说明**

1. 采用"最后补齐差额"算法:
   - 前N-1个商品按比例分摊
   - 最后1个商品 = 总优惠 - 前N-1个商品的优惠
2. 确保分摊后的总金额精确等于满减金额
3. 需要处理小数金额场景(如200.50元)

**验收标准**

- [ ] 测试用例: 3个商品分摊30元满减,总金额精确等于30元
- [ ] 测试用例: 小数金额(200.50元)分摊,精度正确
- [ ] 单元测试验证: `sum(reduceAmount) == fullReduction.getReducePrice()`
- [ ] 财务团队确认: 对账数据100%准确
- [ ] 压力测试: 1000次计算无误差

**验收人**: QA团队 + 财务团队

---

#### 3.1.4 handleNoReduce未设置默认库存

**需求描述**

修复无促销场景下,`realStock`字段未设置导致前端显示null的问题。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:165-168`
- **触发条件**: SKU为null时,未设置`realStock`
- **影响**: 前端显示null,用户体验差
- **严重等级**: 🔴严重

**需求说明**

1. 当`skuStock`为null时,设置`realStock = 0`
2. 当`skuStock`不为null时,设置`realStock = Math.max(0, stock - lockStock)`
3. 确保前端始终收到合法的库存值

**验收标准**

- [ ] 测试用例: SKU为null,realStock返回0
- [ ] 测试用例: 库存充足,realStock正确
- [ ] 测试用例: 锁定库存>总库存,realStock返回0(不是负数)
- [ ] 前端确认: 无null值显示

**验收人**: QA团队 + 前端团队

---

### 3.2 【P1级】高危问题修复

#### 3.2.1 满减规则精度丢失修复

**需求描述**

修复满减规则匹配时使用`intValue()`导致的精度丢失。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:177-187`
- **触发条件**: 商品总价包含小数(如200.50元)
- **影响**: 可能选择错误的满减规则
- **严重等级**: 🟠高危

**需求说明**

1. 使用`BigDecimal.compareTo()`替代`intValue()`
2. 测试小数价格场景,确保规则匹配准确
3. 验证排序正确性

**验收标准**

- [ ] 测试用例: 总价200.50元,正确选择"满200减20"而非"满200.60减30"
- [ ] 单元测试包含小数价格场景
- [ ] 所有BigDecimal比较都使用compareTo()
- [ ] 满减规则匹配准确率100%

**验收人**: QA团队

---

#### 3.2.2 阶梯排序整数溢出修复

**需求描述**

修复阶梯规则排序时可能的整数溢出风险。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:214`
- **触发条件**: 阶梯数量值很大(接近Integer.MAX_VALUE)
- **影响**: 排序错误,选择错误的阶梯规则
- **严重等级**: 🟠高危

**需求说明**

1. 使用`Comparator.comparingInt().reversed()`替代减法
2. 测试大数值场景(Integer.MAX_VALUE)

**验收标准**

- [ ] 测试用例: 阶梯数量为Integer.MAX_VALUE,排序正确
- [ ] 单元测试包含大数值场景
- [ ] 使用Java 8+ API,无手动减法

**验收人**: QA团队

---

#### 3.2.3 购物车添加价格验证

**需求描述**

购物车添加商品时,从数据库查询真实商品信息,防止价格篡改。

**问题详情**

- **位置**: `OmsCartItemServiceImpl.java:39-54`
- **触发条件**: 客户端传入恶意价格(如0.01元)
- **影响**: 价格可能被篡改,造成经济损失
- **严重等级**: 🟠高危

**需求说明**

1. 添加购物车前,从数据库查询商品真实信息
2. 强制使用服务端的价格、商品名称、图片等数据
3. 验证SKU是否存在,库存是否充足
4. 客户端传入的数据全部忽略

**技术约束**

1. 需要考虑性能问题:
   - 每次添加都查询数据库会增加响应时间
   - 建议增加Redis缓存商品信息(缓存5分钟)
2. 需要考虑并发问题:
   - 增加唯一索引: `UNIQUE(member_id, product_id, sku_id)`
   - 并发添加相同商品时,后者更新数量
3. 需要考虑事务问题:
   - 查询和插入需要在同一事务中
   - 防止查询后商品被删除

**验收标准**

- [ ] 安全测试: 客户端传入0.01元,实际保存真实价格
- [ ] 安全测试: 修改商品名称,实际保存真实名称
- [ ] 性能测试: 添加购物车响应时间 < 200ms(含缓存)
- [ ] 并发测试: 100并发添加相同商品,数据正确
- [ ] 单元测试覆盖: 商品不存在、SKU不存在、库存不足

**验收人**: 安全团队 + QA团队

---

#### 3.2.4 促销商品查找性能优化

**需求描述**

优化促销商品查找逻辑,将时间复杂度从O(N×M)降低到O(N+M)。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:265-272`
- **触发条件**: 购物车商品数量较多(50+)
- **影响**: 查询响应时间过长(>1秒)
- **严重等级**: 🟠高危

**需求说明**

1. 将`List<PromotionProduct>`转换为`Map<Long, PromotionProduct>`
2. 使用Map的O(1)查找替代List的O(M)线性查找
3. 确保功能无回归

**性能目标**

| 商品数量 | 优化前 | 优化后 | 提升 |
|---------|-------|-------|-----|
| 10个 | ~100ms | ~50ms | 50% |
| 50个 | ~800ms | ~200ms | 75% |
| 100个 | ~2000ms | ~400ms | 80% |

**验收标准**

- [ ] 性能测试: 100个商品响应时间 < 500ms
- [ ] 功能测试: 所有促销类型计算结果正确
- [ ] 单元测试: 无功能回归
- [ ] 代码审查: 确认使用Map优化

**验收人**: QA团队 + 性能测试

---

#### 3.2.5 数据库索引优化

**需求描述**

为促销查询SQL的JOIN字段添加索引,提升查询性能。

**问题详情**

- **位置**: `PortalProductDao.xml:45-73`
- **触发条件**: 大批量商品查询
- **影响**: 数据库查询慢(>300ms)
- **严重等级**: 🟠高危

**需求说明**

1. 添加索引:
   ```sql
   ALTER TABLE pms_sku_stock ADD INDEX idx_product_id (product_id);
   ALTER TABLE pms_product_ladder ADD INDEX idx_product_id (product_id);
   ALTER TABLE pms_product_full_reduction ADD INDEX idx_product_id (product_id);
   ```
2. 使用`EXPLAIN`验证索引生效
3. 评估索引对写入性能的影响

**风险评估**

| 风险 | 影响 | 应对措施 |
|------|-----|---------|
| 在线DDL锁表 | 短暂不可写 | 使用pt-online-schema-change工具 |
| 索引影响写入性能 | INSERT/UPDATE变慢 | 监控写入性能,必要时调整 |
| 索引空间占用 | 磁盘空间增加 | 评估磁盘空间(预计<100MB) |

**验收标准**

- [ ] EXPLAIN显示使用索引(type=ref或eq_ref)
- [ ] 性能测试: 查询时间降低50%以上
- [ ] 监控: 写入性能无明显下降(<5%)
- [ ] DBA审批: 索引方案通过审批

**验收人**: DBA + QA团队

---

### 3.3 【P2级】中危优化

#### 3.3.1 库存计算负数修复

**需求描述**

修复库存计算可能为负数的问题。

**问题详情**

- **位置**: 多处(48, 73, 96, 167行)
- **触发条件**: 锁定库存 > 总库存
- **影响**: 前端显示负库存(如"-10件")
- **严重等级**: 🟡中危

**需求说明**

1. 使用`Math.max(0, stock - lockStock)`确保不为负
2. 所有设置`realStock`的地方都要处理

**验收标准**

- [ ] 测试用例: 锁定库存>总库存,realStock显示0
- [ ] 代码审查: 所有realStock设置都使用Math.max()

**验收人**: QA团队

---

#### 3.3.2 IN查询参数数量限制

**需求描述**

限制批量查询的商品数量,防止SQL语句过长。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:115-120`
- **触发条件**: 购物车商品数量超过100个
- **影响**: SQL语句过长,性能问题
- **严重等级**: 🟡中危

**需求说明**

1. 限制单次查询最多100个商品
2. 超限时返回友好错误提示

**验收标准**

- [ ] 测试用例: 101个商品,抛出ApiException
- [ ] 错误提示: "购物车商品数量超过限制(最多100个)"

**验收人**: QA团队

---

#### 3.3.3 重复排序优化

**需求描述**

在数据库层完成排序,减少Java内存排序。

**问题详情**

- **位置**: `OmsPromotionServiceImpl.java:177, 211`
- **触发条件**: 每次查询都排序
- **影响**: 性能浪费
- **严重等级**: 🟡中危

**需求说明**

1. 在SQL中添加`ORDER BY ladder.count DESC, full_re.full_price DESC`
2. 删除Java中的`sort()`调用

**验收标准**

- [ ] SQL包含ORDER BY子句
- [ ] Java代码中无sort()调用
- [ ] 功能无回归

**验收人**: QA团队

---

#### 3.3.4 循环创建对象优化

**需求描述**

预分配集合容量,减少GC压力。

**问题详情**

- **位置**: 多处循环
- **触发条件**: 大批量商品
- **影响**: GC频繁
- **严重等级**: 🟡中危

**需求说明**

1. 使用`new ArrayList<>(itemList.size())`预分配容量

**验收标准**

- [ ] 代码审查: 集合初始化时指定容量
- [ ] GC日志: Full GC次数无明显增加

**验收人**: Tech Lead

---

## 四、技术约束

### 4.1 技术栈限制

**必须遵守**:
- JDK 1.8 (不能使用Java 9+特性)
- Spring Boot 2.7.5
- MyBatis 3.5.9
- MySQL 5.7

**不允许**:
- 引入新的框架(如Guava、Apache Commons)
- 修改Spring Boot版本
- 修改数据库版本

### 4.2 性能要求

| 指标 | 当前 | 目标 | 度量方式 |
|------|-----|-----|---------|
| 购物车查询响应时间 | ~1000ms | < 500ms | JMeter压力测试(95th百分位) |
| 促销计算时间 | ~500ms | < 200ms | 方法级性能监控 |
| 数据库查询时间 | ~300ms | < 100ms | Slow Query Log |
| 并发QPS | ~500 | > 1000 | JMeter并发测试 |

### 4.3 安全要求

| 要求 | 说明 |
|------|------|
| 代码审计 | SonarQube扫描通过,无Critical问题 |
| 安全测试 | 无高危安全漏洞 |
| 渗透测试 | 通过第三方安全公司渗透测试 |

### 4.4 兼容性要求

| 维度 | 要求 |
|------|------|
| API兼容性 | 接口不能删除字段,只能新增 |
| 数据库兼容性 | 新增字段必须允许NULL或有默认值 |
| 前端兼容性 | 新增字段前端可选处理 |

---

## 五、项目计划

### 5.1 分阶段计划

**阶段1: P0级Bug修复 (第1-2周)**

| 任务 | 负责人 | 工时 | 依赖 | 产出 |
|------|-------|------|-----|------|
| 需求评审会议 | 产品+技术 | 4h | 无 | 评审纪要 |
| 技术方案设计 | Tech Lead | 1天 | 需求评审 | 技术设计文档 |
| 设计评审会议 | 技术团队 | 2h | 技术方案 | 评审纪要 |
| 空指针异常修复 | 开发A | 1天 | 设计评审 | 代码+单元测试 |
| 除零异常修复 | 开发A | 0.5天 | 设计评审 | 代码+单元测试 |
| 精度问题修复 | 开发A | 1天 | 设计评审 | 代码+单元测试 |
| realStock修复 | 开发A | 0.5天 | 设计评审 | 代码+单元测试 |
| 代码审查(第1轮) | Tech Lead | 0.5天 | 开发完成 | 审查意见 |
| 修改代码 | 开发A | 0.5天 | 代码审查 | 修改后代码 |
| 代码审查(第2轮) | Tech Lead | 0.5天 | 修改完成 | 审查通过 |
| 集成测试 | 测试B | 2天 | 代码审查通过 | 测试报告 |
| Bug修复 | 开发A | 0.5天 | 测试反馈 | Bug修复 |

**小计**: 约10个工作日

---

**阶段2: P1级问题修复 (第3-4周)**

| 任务 | 负责人 | 工时 | 依赖 | 产出 |
|------|-------|------|-----|------|
| 满减规则精度修复 | 开发A | 0.5天 | 阶段1完成 | 代码 |
| 阶梯排序修复 | 开发A | 0.5天 | 阶段1完成 | 代码 |
| 价格验证方案设计 | Tech Lead | 1天 | 无 | 设计方案 |
| 价格验证开发 | 开发A | 2天 | 方案设计 | 代码 |
| Redis缓存开发 | 开发C | 1天 | 价格验证 | 缓存逻辑 |
| Map优化开发 | 开发A | 1天 | 无 | 代码 |
| 数据库索引评审 | DBA | 0.5天 | 无 | 评审意见 |
| 添加索引 | DBA | 0.5天 | 评审通过 | 索引脚本 |
| 代码审查 | Tech Lead | 1天 | 开发完成 | 审查通过 |
| 性能测试 | 测试B | 2天 | 代码审查 | 性能报告 |
| 安全测试 | 安全D | 2天 | 代码审查 | 安全报告 |

**小计**: 约12个工作日

---

**阶段3: P2级优化 + 上线准备 (第5周)**

| 任务 | 负责人 | 工时 | 依赖 | 产出 |
|------|-------|------|-----|------|
| 库存计算修复 | 开发A | 0.5天 | 无 | 代码 |
| IN查询限制 | 开发A | 0.5天 | 无 | 代码 |
| 排序优化 | 开发A | 0.5天 | 无 | 代码 |
| 对象创建优化 | 开发A | 0.5天 | 无 | 代码 |
| 回归测试 | 测试B | 2天 | 全部开发完成 | 测试报告 |
| 文档更新 | 开发A | 1天 | 无 | 技术文档 |
| 灰度发布方案 | 运维F | 1天 | 无 | 灰度方案 |
| 监控配置 | 运维F | 0.5天 | 无 | 监控大盘 |
| 团队培训 | Tech Lead | 0.5天 | 无 | 培训材料 |

**小计**: 约7个工作日

---

### 5.2 工作量汇总

| 类别 | 乐观估计 | 保守估计 | 实际采用 |
|------|---------|---------|---------|
| 开发 | 10天 | 15天 | 12天 |
| 测试 | 6天 | 8天 | 7天 |
| 评审/会议 | 2天 | 3天 | 2天 |
| 缓冲时间 | 2天 | 5天 | 4天 |
| **总计** | **20天** | **31天** | **25天** |

**说明**: 
- 采用保守估计,约**5周**(25个工作日)
- 包含20%缓冲时间
- 假设无重大阻塞问题

### 5.3 里程碑

| 里程碑 | 日期 | 交付物 | 验收标准 |
|-------|------|--------|---------|
| M1: 需求评审通过 | Day 1 | 评审纪要 | 产品+技术签字 |
| M2: 技术方案评审通过 | Day 2 | 技术设计文档 | Tech Lead签字 |
| M3: P0级Bug修复完成 | Day 10 | 代码+测试报告 | 集成测试通过 |
| M4: P1级问题修复完成 | Day 22 | 代码+性能报告 | 性能测试通过 |
| M5: P2级优化完成 | Day 25 | 代码+回归报告 | 回归测试通过 |
| M6: 灰度发布(5%) | Day 26 | 灰度环境 | 监控无告警 |
| M7: 全量上线 | Day 30 | 生产环境 | 验收通过 |

### 5.4 人力资源

| 角色 | 人数 | 投入时间 | 关键职责 |
|------|-----|---------|---------|
| 产品经理 | 1 | 20% | 需求确认、验收 |
| Tech Lead | 1 | 30% | 方案设计、代码审查 |
| 后端开发 | 2 | 100% | 代码开发、单元测试 |
| QA测试 | 1 | 80% | 集成测试、性能测试 |
| 安全工程师 | 1 | 20% | 安全测试 |
| DBA | 1 | 10% | 索引评审、添加索引 |
| 运维工程师 | 1 | 20% | 灰度发布、监控配置 |

---

## 六、风险管理

### 6.1 技术风险

| 风险 | 概率 | 影响 | 应对措施 | 负责人 |
|------|-----|-----|---------|--------|
| **价格验证影响性能** | 高 | 高 | 1. 增加Redis缓存<br>2. 异步查询商品信息<br>3. 性能测试验证 | Tech Lead |
| **数据库索引锁表** | 中 | 高 | 1. 使用pt-online-schema-change<br>2. 在业务低峰期执行<br>3. 准备回滚脚本 | DBA |
| **并发问题导致重复数据** | 中 | 中 | 1. 增加唯一索引<br>2. 捕获重复键异常<br>3. 并发测试验证 | 开发A |
| **Map优化引入新Bug** | 低 | 中 | 1. 充分的单元测试<br>2. 代码审查<br>3. 灰度验证 | Tech Lead |
| **精度算法复杂度高** | 低 | 中 | 1. 代码详细注释<br>2. 单元测试覆盖<br>3. 性能测试 | 开发A |
| **Redis缓存不一致** | 中 | 中 | 1. 设置合理过期时间(5分钟)<br>2. 商品更新时主动清除缓存 | 开发C |
| **测试环境数据不全** | 中 | 中 | 1. 从生产导入脱敏数据<br>2. 准备完整测试数据 | 测试B |
| **第三方依赖冲突** | 低 | 低 | 1. 不引入新依赖<br>2. 充分测试 | Tech Lead |

### 6.2 业务风险

| 风险 | 概率 | 影响 | 应对措施 | 负责人 |
|------|-----|-----|---------|--------|
| **实时计算设计被质疑** | 中 | 高 | 1. 与产品确认设计意图<br>2. 如需改为价格快照,单独立项 | 产品 |
| **用户投诉价格变化** | 高 | 中 | 1. 暂不实施价格快照<br>2. 如有投诉,再评估 | 产品 |
| **财务对账流程变更** | 低 | 中 | 1. 与财务确认精度要求<br>2. 提供对账工具 | 产品 |
| **促销规则理解偏差** | 低 | 低 | 1. 与产品确认规则<br>2. 文档详细说明 | 产品 |

### 6.3 协作风险

| 风险 | 概率 | 影响 | 应对措施 | 负责人 |
|------|-----|-----|---------|--------|
| **前后端联调时间不足** | 中 | 中 | 1. 提前同步接口变更<br>2. 预留2天联调时间 | Tech Lead |
| **DBA资源不足** | 中 | 中 | 1. 提前预约DBA时间<br>2. 索引方案提前评审 | Tech Lead |
| **安全团队排期紧张** | 高 | 中 | 1. 提前1周申请安全测试<br>2. 准备自测报告 | 开发A |
| **测试环境不稳定** | 中 | 低 | 1. 提前检查测试环境<br>2. 准备备用环境 | 运维F |

### 6.4 上线风险

| 风险 | 概率 | 影响 | 应对措施 | 负责人 |
|------|-----|-----|---------|--------|
| **灰度期间发现Bug** | 中 | 高 | 1. 5% → 20% → 50% → 100%分步灰度<br>2. 每步观察2天<br>3. 准备回滚方案 | 运维F |
| **性能不达标** | 低 | 高 | 1. 灰度期间密切监控<br>2. 准备降级开关<br>3. 紧急扩容方案 | 运维F |
| **数据库主从延迟** | 低 | 中 | 1. 监控主从延迟<br>2. 关键操作强制走主库 | DBA |
| **高峰期流量冲击** | 中 | 高 | 1. 避开业务高峰(晚8-10点)<br>2. 准备流量降级 | 运维F |

---

## 七、验收标准

### 7.1 功能验收

**验收方式**: 测试用例 + 人工验收

**验收标准**:

| 项目 | 验收标准 | 验收方法 | 负责人 |
|------|---------|---------|--------|
| P0级Bug | 4个Bug全部修复 | 执行回归测试用例 | QA |
| P1级问题 | 6个问题全部修复 | 执行功能测试用例 | QA |
| P2级优化 | 4个优化全部完成 | 代码审查+抽样测试 | Tech Lead |
| 单元测试 | 覆盖率 > 60% | JaCoCo报告 | 开发A |
| 集成测试 | 全部通过 | 测试报告 | QA |
| 代码审查 | 无Critical问题 | SonarQube报告 | Tech Lead |

**验收步骤**:
1. QA执行完整测试用例(预计100+用例)
2. Tech Lead审查代码和单元测试
3. 产品经理抽查关键场景
4. 所有验收项通过后,产品经理签字

---

### 7.2 性能验收

**验收方式**: JMeter压力测试

**验收标准**:

| 指标 | 目标值 | 测试方法 | 负责人 |
|------|-------|---------|--------|
| 购物车查询(10商品) | < 200ms (95th) | JMeter 1000并发 | 测试B |
| 购物车查询(50商品) | < 500ms (95th) | JMeter 1000并发 | 测试B |
| 购物车添加 | < 200ms (95th) | JMeter 500并发 | 测试B |
| QPS | > 1000 | JMeter压力测试 | 测试B |
| CPU使用率 | < 70% | 监控系统 | 运维F |
| 内存使用率 | < 70% | 监控系统 | 运维F |
| 数据库慢查询 | 0条 | Slow Query Log | DBA |

**验收步骤**:
1. 测试B执行性能测试(持续1小时)
2. 收集性能数据和监控截图
3. 所有指标达标后,Tech Lead签字

---

### 7.3 安全验收

**验收方式**: 安全测试 + 渗透测试

**验收标准**:

| 项目 | 验收标准 | 测试方法 | 负责人 |
|------|---------|---------|--------|
| 价格篡改 | 无法篡改 | 手动测试 | 安全D |
| SQL注入 | 无SQL注入 | SQLMap扫描 | 安全D |
| XSS攻击 | 无XSS漏洞 | 手动测试 | 安全D |
| 越权访问 | 无越权问题 | 手动测试 | 安全D |
| 代码扫描 | 无Critical问题 | SonarQube | 开发A |

**验收步骤**:
1. 安全D执行安全测试
2. 开发A修复安全问题
3. 安全D复测通过
4. 安全D签字确认

---

### 7.4 验收流程

```
第1步: 单元测试
├─ 开发A执行单元测试
├─ JaCoCo报告 > 60%
└─ Tech Lead审查通过

第2步: 集成测试
├─ QA执行功能测试
├─ QA执行回归测试
├─ 测试通过率 = 100%
└─ QA签字

第3步: 性能测试
├─ 测试B执行性能测试
├─ 所有指标达标
└─ Tech Lead签字

第4步: 安全测试
├─ 安全D执行安全测试
├─ 无高危漏洞
└─ 安全D签字

第5步: 产品验收
├─ 产品抽查关键场景
├─ 所有功能符合预期
└─ 产品签字

第6步: 上线审批
├─ Tech Lead、QA、产品、安全签字
├─ 运维F确认上线方案
└─ 提交上线申请
```

---

## 八、附录

### 8.1 待评审需求清单

以下需求需要**产品评审会议**讨论:

**需求1: 价格快照机制**
- **问题**: 用户看到价格频繁变化
- **方案**: 记录添加购物车时的价格快照
- **冲突**: 与现有"实时计算"设计冲突
- **影响**: 需要数据库表结构变更
- **工作量**: 约5天
- **风险**: 高(数据一致性、兼容性)
- **建议**: 单独立项,充分评估后再实施

**需求2: 库存状态友好提示**
- **问题**: 库存数字不够友好
- **方案**: 显示"库存充足"/"库存紧张"/"已售罄"
- **影响**: 需要前后端联动
- **工作量**: 约2天
- **风险**: 低
- **建议**: 第二期实施

**需求3: 价格变更通知**
- **问题**: 用户不知道价格变了
- **方案**: 价格变更时发送站内信/短信
- **影响**: 需要消息系统支持
- **工作量**: 约3天
- **风险**: 中(依赖消息系统)
- **建议**: 依赖价格快照,暂不实施

### 8.2 参考文档

- [Bug与安全漏洞分析报告(修正版)](./step-3-3-bugs-and-security-analysis-corrected.md)
- [分析过程与错误修正](./step-3-4-analysis-process-and-corrections.md)
- [PRD修正分析](./step-4-2-prd-review-and-corrections.md)
- [测试用例与测试数据](./step-4-1-test-cases-and-data.md)

### 8.3 术语表

| 术语 | 说明 |
|------|------|
| **SKU** | Stock Keeping Unit,库存量单位,即商品规格 |
| **促销类型** | 1=单品促销, 3=阶梯价格, 4=满减优惠 |
| **实时计算** | 每次查询都重新计算最新价格,不缓存 |
| **价格快照** | 记录用户添加购物车时的价格,后续不变 |
| **P0/P1/P2** | 优先级,P0=严重必须立即修复, P1=高危尽快修复, P2=中危逐步优化 |
| **灰度发布** | 分步放量,逐步上线(5% → 20% → 50% → 100%) |
| **回归测试** | 验证修复后其他功能是否受影响 |

### 8.4 评审记录

| 评审会议 | 时间 | 参与人 | 结论 | 纪要 |
|---------|------|-------|------|------|
| 需求评审 | 待定 | 产品+技术 | 待评审 | - |
| 技术方案评审 | 待定 | 技术团队 | 待评审 | - |
| 代码审查 | 待定 | Tech Lead | 待评审 | - |
| 上线评审 | 待定 | 全员 | 待评审 | - |

---

**文档版本**: v2.0 (修正版)  
**创建时间**: 2026-01-02  
**创建人员**: 产品 + 技术团队  
**最后更新**: 2026-01-02  
**文档状态**: ✅ 待评审  
**下次评审**: 需求评审会议

---

## 变更记录

| 版本 | 日期 | 变更人 | 变更内容 |
|------|------|-------|---------|
| v1.0 | 2026-01-02 | 产品+技术 | 初始版本 |
| v2.0 | 2026-01-02 | 技术团队 | 基于研发组长反馈全面修正 |

**v2.0修正要点**:
1. ✅ 移除未确认需求(价格快照、库存提示)至附录
2. ✅ 调整工作量评估:14天 → 25天
3. ✅ 补充完整的风险管理(20+风险)
4. ✅ 简化技术细节,聚焦需求描述
5. ✅ 增加评审环节和验收流程
6. ✅ 重新划分优先级(P0:4个, P1:6个, P2:5个)
7. ✅ 增加技术约束和兼容性要求
8. ✅ 补充人力资源和角色职责
